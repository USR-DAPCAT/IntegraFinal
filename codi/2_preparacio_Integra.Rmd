---
title: "Estudio INTEGRA: estrategia de INTervención intEgral en pacientes con mal control Glucémico de la diabetes mellitus tipo 2 en el Ámbito de Atención PRimariA"
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades_desti: "dades"
---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>

<div class="watermark">DRAFT</div>

****

# FASE LECTURA

>> Generació de taula plana i aplicació de primers criteris d'inclusió 


```{r setup, include = FALSE}

library("plyr")
library("dplyr")
#library("survminer")
library("purrr")
library("stringr")
#library("tidyverse")
library("tidyr")
library("compareGroups")
library("rmarkdown")
library("RODBC")
library("devtools")
library("pander")
library("hablar")




# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

#dir_dades<-"dades"
directori_dades<-params$dir_dades_origen


```
## 1. Lectura 
```{r lectura}

#----------------------------------------------------------------------#
#channel2<-odbcConnectAccess2007("dades/INTEGRABBDDJULIO01072019_22.07.2019.accdb")
#----------------------------------------------------------------------#

TAULA_PLANA<-readRDS(here::here(params$dir_dades_desti,"TAULA_PLANA.rds")) %>% as_tibble()

```



## Recodificacions i calculs
```{r recodificacions1,include=F}


#TAULA_PLANA$duracioDiabetesMesos
TAULA_PLANA$duracioDiabetesMesos2<-as.numeric(TAULA_PLANA$duracioDiabetesMesos2)
#TAULA_PLANA<-TAULA_PLANA%>%mutate(duracioDiabetesMesos=if_na(duracioDiabetesMesos,0))
#TAULA_PLANA<-TAULA_PLANA%>%mutate(duracioDiabetesMesos2=duracioDiabetesAnys*12+duracioDiabetesMesos)
TAULA_PLANA<-TAULA_PLANA%>%mutate(duracioDiabetesAnys2=duracioDiabetesMesos2/12)

TAULA_PLANA$duracioDiabetesMesos2<-as.numeric(TAULA_PLANA$duracioDiabetesMesos2)
TAULA_PLANA$edat<-as.numeric(TAULA_PLANA$edat)
TAULA_PLANA$imc<-as.numeric(TAULA_PLANA$imc)
TAULA_PLANA$tensioDiastolica<-as.numeric(TAULA_PLANA$tensioDiastolica)
TAULA_PLANA$tensioSistolica<-as.numeric(TAULA_PLANA$tensioSistolica)
TAULA_PLANA$hba1cIFCC<-as.numeric(TAULA_PLANA$hba1cIFCC)
TAULA_PLANA$hba1cNGSP<-as.numeric(TAULA_PLANA$hba1cNGSP)

#TAULA_PLANA<-mutate_at(TAULA_PLANA, vars( starts_with("ado") ), funs( if_else(.=="---"   ,0,1)))

#TAULA_PLANA<-TAULA_PLANA %>% mutate(
#     GRUP_DIABETIC_CAT2 = case_when(
#          DM1==1 ~ 1,
#          (DM2==1 | FX.ADO=="20200520") ~ 2,
#          G_DIABETIC==1 ~ 3,
#          TRUE ~ 0
#     ))


TAULA_PLANA<-TAULA_PLANA %>% mutate(
    adoRepaglinida_id = case_when(adoRepaglinida_id=="No" ~ "No",
                                   adoRepaglinida_id=="Si" ~ "Si",
                                   adoRepaglinida_id=="NA" ~ NA_character_,
                                   adoRepaglinida_id=="---" ~ NA_character_))
TAULA_PLANA<-TAULA_PLANA %>% mutate(
    hta_id = case_when(hta_id=="No" ~ "No",
                                   hta_id=="Si" ~ "Si",
                                   hta_id=="NA" ~ NA_character_,
                                   hta_id=="---" ~ NA_character_))
                                   
                                   
TAULA_PLANA<-TAULA_PLANA %>% mutate(
    hta_id = case_when(hta_id=="No" ~ "No",
                                   hta_id=="Si" ~ "Si",
                                   TRUE ~ NA_character_,
                                   ))
                                   


```


## 4. Salvar taula plana 
```{r salvar}

saveRDS(TAULA_PLANA,     file=here::here(params$dir_dades_desti,"TAULA_PLANA.rds"))



```


