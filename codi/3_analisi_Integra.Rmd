---
title: "Estudio INTEGRA: estrategia de INTervención intEgral en pacientes con mal control Glucémico de la diabetes mellitus tipo 2 en el Ámbito de Atención PRimariA"
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"

output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades_origen: "../../DADES/INTEGRA" 
  dir_dades_desti: "dades"
---
&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****

## 0. Estat:

**agregacions i part global descriptiva**


&check; xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <br/>


Desembre / 2021

&check; xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <br/>



 
**Pendents**

&check; Revisio i depuracio errors.   <br/>

# Fase de validacio de base

## Fase Preparacio


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

gc()

library("plyr")
library("dplyr")
library("purrr")
library("stringr")
library("tidyr")
library("compareGroups")
library("rmarkdown")
library("RODBC")
library("devtools")
library("pander")
library("hablar")




# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

directori_dades<-params$dir_dades_origen

conductor<-here::here("Integra_Conductor.xls")


```

```{r llegir, include = FALSE}


#######################################################
# Llegir plana
#dades_basal<-readRDS(here::here(params$dir_dades_desti,"TAULA_PLANA_BASAL_LAB.rds")) %>% as_tibble()
#dades<-readRDS(here::here(params$dir_dades_desti,"TAULA_PLANA_HISTORIC_LAB.rds")) %>% as_tibble()


dades_basal<-readRDS(here::here(params$dir_dades_desti,"DT_VISITA_BASAL.rds")) %>% as_tibble()
dades_MES03<-readRDS(here::here(params$dir_dades_desti,"DT_VISITA_MES03.rds")) %>% as_tibble()
dades_MES06<-readRDS(here::here(params$dir_dades_desti,"DT_VISITA_MES06.rds")) %>% as_tibble()
dades_final<-readRDS(here::here(params$dir_dades_desti,"DT_VISITA_FINAL.rds")) %>% as_tibble()
dades<-readRDS(here::here(params$dir_dades_desti,"TAULA_PLANA.rds")) %>% as_tibble()

# Filtrem  i ELIMINEM els Difunts anteriors al 20



```
## 1. Flow chart 
```{r Flow chart, include=T}



dades_basal<-dades_basal%>%mutate(exclusio1=ifelse(duracioDiabetesMesos2<12,1,0))
#dades<-dades%>%mutate(exclusio1=ifelse(duracioDiabetesMesos2<12,1,0))



flow_chart1<-criteris_exclusio_diagrama(dt=dades_basal,
                                        taulavariables=conductor,
                                        criteris = "exc_pre",
                                        ordre="exc_ordre",
                                        grups=NA,
                                        etiquetes="descripcio",
                                        sequencial = T,
                                        pob_lab=c("Estudio INTEGRA  ","Estudio INTEGRA sin exclusiones"),
                                        colors=c("white","grey"),
                                        forma=c("ellipse","box"))

flow_chart1



#DT_VISITA_HISTORIC<-DT_VISITA_HISTORIC%>%filter(pacient_id%in%DT_PACIENT_SELECT$pacient_id)


dades_basal<-dades_basal%>%filter(exclusio1==0)
#dades<-dades%>%filter(exclusio1==0)
dades_basal_SELECT<-dades_basal%>%dplyr::select(pacient_id)


dades_MES03<-dades_MES03%>%filter(pacient_id%in%dades_basal_SELECT$pacient_id)
dades_MES06<-dades_MES06%>%filter(pacient_id%in%dades_basal_SELECT$pacient_id)
dades_final<-dades_final%>%filter(pacient_id%in%dades_basal_SELECT$pacient_id)
dades<-dades%>%filter(pacient_id%in%dades_basal_SELECT$pacient_id)



#dades_basal<-criteris_exclusio(dades_basal,taulavariables=conductor,criteris="exc_pre")
#dades<-criteris_exclusio(dades,taulavariables=conductor,criteris="exc_pre")



```


```{r recodes}
#conductor_variables<-"Integra_Conductor.xls"
DT_VISITA_BASAL_lab<-convertir_dates(d=dades_basal,taulavariables=conductor)
DT_VISITA_BASAL_lab<-etiquetar(d=DT_VISITA_BASAL_lab,taulavariables=conductor)



DT_VISITA_BASAL_lab<-etiquetar_valors(dt=DT_VISITA_BASAL_lab,variables_factors=conductor,fulla="etiquetes0",camp_etiqueta="etiqueta2")


# CAmbiar categoria de referencia
DT_VISITA_BASAL_lab<-DT_VISITA_BASAL_lab %>% refcat(conductor = conductor,ref = "refcat")


                        #####################################
                          #V  I S I T A       H I S T O R I C #------------------
                          #####################################

# 
# #conductor_variables<-"Integra_Conductor.xls"
# DT_VISITA_HISTORIC_lab<-convertir_dates(d=DT_VISITA_HISTORIC_FINAL,taulavariables=conductor)
# DT_VISITA_HISTORIC_lab<-etiquetar(d=DT_VISITA_HISTORIC_lab,taulavariables=conductor)
# DT_VISITA_HISTORIC_lab<-etiquetar_valors(dt=DT_VISITA_HISTORIC_lab,variables_factors=conductor,fulla="etiquetes0",camp_etiqueta="etiqueta1")


```



## 2.1 Descriptiva Basal
```{r Resultats0, include=T}

#i)






formu_1<-formula_table1("taula",y="",taulavariables=conductor,dt=dades_basal)
formu_2<-formula_table1("taula",y="grupIntervencio",taulavariables=conductor,dt=dades_basal)


table1::table1(formu_1,
               data = dades_basal,caption="TAULA 1.Descriptiva BASAL",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")


```

```{r}

dades_basal %>% select(centre_id)

table1::table1(~ centre_id  | grupIntervencio,
               data = DT_VISITA_BASAL_lab,caption="TAULA 1.Descriptiva BASAL",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")

```

## Analisis de l'outcome (Change from baseline in HbA1c)

```{r}

DT_VISITA_BASAL_lab %>% select(hba1cNGSP)

dades_final
dades_MES03
dades_MES06

dt_temp<-
  dades %>% 
  select(pacient_id,tipus,grupIntervencio,centre_id,hba1cNGSP) %>% 
  arrange(pacient_id) %>% 
  na.omit()


dt_temp

  
```

# Analisis de achiving the HbA1c < 7% target

```{r}

## Reg logistica condicional
dt_temp<-
  DT_VISITA_BASAL_lab %>% 
  left_join(
    
    dades %>% filter(tipus=="Mes12") %>% 
      select(pacient_id,hba1cNGSP_final=hba1cNGSP),
    by="pacient_id"
    
  )

dt_temp<-
  dt_temp %>% 
  # select(pacient_id,centre_id,grupIntervencio,hba1cNGSP,hba1cNGSP_final) %>% 
  # na.omit() %>% 
  mutate(hba1cNGSP_7=if_else(hba1cNGSP_final<7,1,0))


dt_temp %>% select(edat,sexe_id)


glm(hba1cNGSP_7~grupIntervencio+hba1cNGSP+edat+sexe_id+imc + hta_id + dislipemia_id + duracioDiabetesMesos2
    ,family = "binomial",data = dt_temp) %>% 
  parameters::parameters(exp=T)

table(dt_temp$hta_id)

```

## 2.2 Descriptiva per grupIntervencio Basal
```{r Resultats1, include=T}

#ii)



table1::table1(formu_2,
               data = dades_basal,caption="TAULA 2.Descriptiva Basal per grupIntervencio",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")







```
## 2.3 Descriptiva    General
```{r Resultats2, include=T}

#iii)


table1::table1(formu_1,
               data = dades,caption="TAULA 1.Descriptiva GENERAL",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min,Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")


formula_taula_HISTORIC<-formula_compare("taula0",y="",taulavariables = conductor)

descrTable(formula_taula_HISTORIC,method = 2,Q1 = 0, Q3 =1 ,show.p.overall = F,data=dades,max.xlev = 40)%>%
  export2md(header.background = "grey", header.color = "white", size=12,caption = "TAULA 1.Descriptiva GENERAL")




```



```
## 4. Salvar taula plana
```{r salvar}
#saveRDS(dades, file=here::here(params$dir_dades_desti,"dt_plana_exc.rds"))

```
&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>



