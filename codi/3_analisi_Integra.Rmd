---
title: "Estudi INTEGRA: estratègia d'INTervenció intEgral en pacients amb mal control Glucèmic de la diabetis mellitus tipus 2 a l'Àmbit d'Atenció PRimariA"
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"

output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades_desti: "dades"
---
&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****

## 0. Estat:

**agregacions i part global descriptiva**


&check;  S ha de mirar:  adoAlogliptina_id_ALTRES 
 adoCombiAlogliptinaPioglitazona_id_ALTRES 
 adoCombiMetforminaAlogliptina_id_ALTRES 
 adoCombiMetforminaLinaglibtina_id_ALTRES 
 adoCombMetforminaDapaglifozina_id_ALTRES 
 adoCombMetforminaEmpaglifozina_id_ALTRES 
 ADRENERGICS_INHALANTS_id_ALTRES 
 altreMedicacioGral_id_ALTRES 
 AMPUTACIONS_id_ALTRES 
 AMPUTACIONSBASAL_id_ALTRES 
 antiagregantsPlaquetaris_id_ALTRES 
 anticoagulants_id_ALTRES 
 ANTIDEPRESSANTS_id_ALTRES 
 ANTIEPILEPTICS_id_ALTRES 
 antihipertensius_id_ALTRES 
 ANTIPSYCHOTICS_id_ALTRES 
 ANXIOLYTICS_id_ALTRES 
 CARDIOPATIAISQUEMICABASAL_id_ALTRES 
 CORTICOSTEROIDS_id_ALTRES 
 DISFUNCIOSEXUAL_id_ALTRES 
 DISFUNCIOSEXUALBASAL_id_ALTRES 
 hipolemiants_id_ALTRES 
 HORMONES_id_ALTRES 
 injAbasaglar_id_ALTRES 
 injExenatida_id_ALTRES 
 injToujeo_id_ALTRES 
 injTresiba_id_ALTRES 
 insuficienciaCardiaca_id 
 MALALTIESMENTALS_id_ALTRES 
 MALALTIESMENTALSBASAL_id_ALTRES 
 MPOC_id_ALTRES 
 MPOCBASAL_id_ALTRES 
 NEOPLASIES_id_ALTRES 
 NEOPLASIESBASAL_id_ALTRES 
 NSAID_ALTRES 
 OTHERANALGESICSANDANTIPYRETICS_id_ALTRES 
 PATOLOGIATIROIDAL_id_ALTRES 
 PATOLOGIATIROIDALBASAL_id_ALTRES 
 PEUDIABETIC_id_ALTRES 
 PEUDIABETICBASAL_id_ALTRES 
 RETINOPATIADIABETICABASAL_id_ALTRES 
 THYROIDPREPARATIONS_id_ALTRES 
 <br/>


Desembre / 2021

&check; xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <br/>



 
**Pendents**

&check; Revisio i depuracio errors.   <br/>

# Fase de validacio de base

## Fase Preparacio


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

gc()

library("plyr")
library("dplyr")
library("purrr")
library("stringr")
library("tidyr")
library("compareGroups")
library("rmarkdown")
library("RODBC")
library("devtools")
library("pander")
library("hablar")
library("miceadds")
library("ggplot2")
library("survminer")
library("survival")
library("forestmodel")
library("sjmisc")
library("devtools")
library("sjPlot")
library("jtools")

# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

directori_dades<-params$dir_dades_origen

conductor<-here::here("Integra_Conductor.xls")


```

```{r llegir, include = FALSE}


#######################################################
# Llegir plana
#dades_basal<-readRDS(here::here(params$dir_dades_desti,"TAULA_PLANA_BASAL_LAB.rds")) %>% as_tibble()
#dades<-readRDS(here::here(params$dir_dades_desti,"TAULA_PLANA_HISTORIC_LAB.rds")) %>% as_tibble()



dades<-readRDS(here::here(params$dir_dades_desti,"TAULA_PLANA.rds")) %>% as_tibble()

dades_BASAL<-dades%>%filter(tipus=="Mes00")
dades_MES03<-dades%>%filter(tipus=="Mes03")
dades_MES06<-dades%>%filter(tipus=="Mes06")
dades_FINAL<-dades%>%filter(tipus=="Mes12")



```
## 1. Flow chart 
```{r Flow chart, include=T}



dades_BASAL<-dades_BASAL%>%mutate(exclusio1=ifelse(duracioDiabetesMesos2<12,1,0))
#dades<-dades%>%mutate(exclusio1=ifelse(duracioDiabetesMesos2<12,1,0))



#flow_chart1<-criteris_exclusio_diagrama(dt=dades_BASAL,
#                                        taulavariables=conductor,
#                                        criteris = "exc_pre",
#                                        ordre="exc_ordre",
#                                        grups=NA,
#                                        etiquetes="descripcio",
#                                        sequencial = T,
#                                        pob_lab=c("Estudio INTEGRA  ","Estudio INTEGRA sin exclusiones"),
#                                        colors=c("white","grey"),
#                                        forma=c("ellipse","box"))

#flow_chart1




#DT_VISITA_HISTORIC<-DT_VISITA_HISTORIC%>%filter(pacient_id%in%DT_PACIENT_SELECT$pacient_id)
#mydata %>% filter(! is.na(important_a) | ! is.na(important_b))

dades_BASAL<-dades_BASAL%>%filter(exclusio1==0 &  !is.na(hba1cNGSP))



#filtrem les altres base de dades!


dades_BASAL_SELECT<-dades_BASAL%>%dplyr::select(pacient_id)


dades_MES03<-dades_MES03%>%filter(pacient_id%in%dades_BASAL_SELECT$pacient_id)
dades_MES06<-dades_MES06%>%filter(pacient_id%in%dades_BASAL_SELECT$pacient_id)
dades_FINAL<-dades_FINAL%>%filter(pacient_id%in%dades_BASAL_SELECT$pacient_id)
dades<-dades%>%filter(pacient_id%in%dades_BASAL_SELECT$pacient_id)


# fer el conductor dilluns 17.1.2022:
# variable.names(dades)
#  [1] "tipus"                                      "visita_id"                                  "completa"                                   "dataVisita"                                
#  [5] "dataNaixement"                              "edat"                                       "sexe_id"                                    "etnia_id"                                  
#  [9] "altresEtniaDescrip"                         "problemesSalut_id"                          "clinicalRiskGroup"                          "duracioDiabetesAnys"                       
# [13] "duracioDiabetesMesos"                       "duracioDiabetesMesos2"                      "grupMorbiditatAjustada"                     "dislipemia_id"                             
# [17] "dataDxDislipemia"                           "hta_id"                                     "dataDxHta"                                  "altresProblemesSalut_id"                   
# [21] "altresProblemesSalutDescrip"                "PATOLOGIATIROIDALBASAL_id_ALTRES"           "MPOCBASAL_id_ALTRES"                        "MALALTIESMENTALSBASAL_id_ALTRES"           
# [25] "CARDIOPATIAISQUEMICABASAL_id_ALTRES"        "RETINOPATIADIABETICABASAL_id_ALTRES"        "DISFUNCIOSEXUALBASAL_id_ALTRES"             "NEOPLASIESBASAL_id_ALTRES"                 
# [29] "PEUDIABETICBASAL_id_ALTRES"                 "AMPUTACIONSBASAL_id_ALTRES"                 "freqCardiaca"                               "imc"                                       
# [33] "perimetreCintura"                           "pes"                                        "talla"                                      "tensioDiastolica"                          
# [37] "tensioSistolica"                            "tensioBrac_id"                              "antiagregantsPlaquetaris_id"                "anticoagulants_id"                         
# [41] "antihipertensius_id"                        "hipolemiants_id"                            "altreMedicacioGral_id"                      "altreMedicacioGral_id_ALTRES"              
# [45] "antiagregantsPlaquetaris_id_ALTRES"         "anticoagulants_id_ALTRES"                   "antihipertensius_id_ALTRES"                 "hipolemiants_id_ALTRES"                    
# [49] "ANTIDEPRESSANTS_id_ALTRES"                  "ANTIPSYCHOTICS_id_ALTRES"                   "ANTIEPILEPTICS_id_ALTRES"                   "ANXIOLYTICS_id_ALTRES"                     
# [53] "OPIOIDS_id_ALTRES"                          "CORTICOSTEROIDS_id_ALTRES"                  "OTHERANALGESICSANDANTIPYRETICS_id_ALTRES"   "NSAID_ALTRES"                              
# [57] "ADRENERGICS_INHALANTS_id_ALTRES"            "THYROIDPREPARATIONS_id_ALTRES"              "HORMONES_id_ALTRES"                         "adoAcarbosa_id"                            
# [61] "adoCanagliflozina_id"                       "adoClorpopramida_id"                        "adoCombiGlimepiridaPioglitazona_id"         "adoCombiMetforminaPioglitazona_id"         
# [65] "adoCombiMetforminaSaxaglitina_id"           "adoCombiMetforminaSitagliptina_id"          "adoCombiMetforminaVildagliptina_id"         "adoDapagliflozina_id"                      
# [69] "adoEmpagliflozina_id"                       "adoGlibenclamida_id"                        "adoGlibornurida_id"                         "adoGliclazida_id"                          
# [73] "adoGlimepirida_id"                          "adoGlipizida_id"                            "adoGliquidona_id"                           "adoLinagliptina_id"                        
# [77] "adoMetformina_id"                           "adoMiglitol_id"                             "adoNateglinida_id"                          "adoPioglitazona_id"                        
# [81] "adoRepaglinida_id"                          "adoSaxagliptina_id"                         "adoSitagliptina_id"                         "adoTolbutamida_id"                         
# [85] "adoVildagliptina_id"                        "altreMedicacioADO_id"                       "adoCombiMetforminaLinaglibtina_id_ALTRES"   "adoCombiMetforminaAlogliptina_id_ALTRES"   
# [89] "adoAlogliptina_id_ALTRES"                   "adoCombiAlogliptinaPioglitazona_id_ALTRES"  "adoCombMetforminaEmpaglifozina_id_ALTRES"   "adoCombMetforminaDapaglifozina_id_ALTRES"  
# [93] "injAbasaglar_id"                            "injAbiglutida_id"                           "injActrapid_id"                             "injApidra_id"                              
# [97] "injExenatida_id"                            "injHumalog_id"                              "injHumalogBasal_id"                         "injHumalogMix25_id"                        
#[101] "injHumalogMix50_id"                         "injHumilana3070_id"                         "injHumulinaNPH_id"                          "injHumulinaRegular_id"                     
#[105] "injInsulatard_id"                           "injLantus_id"                               "injLevemir_id"                              "injLiraglutida_id"                         
#[109] "injLixisenatide_id"                         "injMixtard30_id"                            "injNovomix30_id"                            "injNovomix50_id"                           
#[113] "injNovomix70_id"                            "injNovorapid_id"                            "altreMedicacioInjInsulina_id"               "injToujeo_id_ALTRES"                       
#[117] "injTresiba_id_ALTRES"                       "injExenatida_id_ALTRES"                     "injAbasaglar_id_ALTRES"                     "dataAnalitica"                             
#[121] "glucosa"                                    "hba1cIFCC"                                  "hba1cNGSP"                                  "alt"                                       
#[125] "ast"                                        "ggt"                                        "colesterolHdl"                              "colesterolLdl"                             
#[129] "colesterolNoHdl"                            "colesterolTtl"                              "triglicerids"                               "volumCorpuscularMig"                       
#[133] "hematocrit"                                 "hemoglobina"                                "hemoglobinaCorpuscularMitja"                "ide"                                       
#[137] "hematies"                                   "leucocits"                                  "plaquetes"                                  "linfocits"                                 
#[141] "monocits"                                   "neutrofils"                                 "eosinofils"                                 "basofils"                                  
#[145] "creatinina"                                 "filtratGlomerular"                          "filtratGlomerularSuperior60"                "orinaCreatinina"                           
#[149] "orinaMicroalbuminuria"                      "orinaMicroalbuminuriaCreatinina"            "cigarretsDia"                               "dataFiTabac"                               
#[153] "dataIniciTabac"                             "fumador_id"                                 "motiuNoSeguiment"                           "seguimentRecomenacions_id"                 
#[157] "arteriopatiaPeriferica_id"                  "cardiopatiaIsquemica_id"                    "insuficienciaCardiaca_id"                   "malaltiaCerebrovascular_id"                
#[161] "nefropatiaDiabetica_id"                     "neuropatiaDiabetica_id"                     "retinopatiaDiabetica_id"                    "altresComplicacions_id"                    
#[165] "PATOLOGIATIROIDAL_id_ALTRES"                "MPOC_id_ALTRES"                             "MALALTIESMENTALS_id_ALTRES"                 "DISFUNCIOSEXUAL_id_ALTRES"                 
#[169] "NEOPLASIES_id_ALTRES"                       "PEUDIABETIC_id_ALTRES"                      "AMPUTACIONS_id_ALTRES"                      "ingresCopsRelDiabetesNo"                   
#[173] "ingresCopsRelDiabetesSi"                    "urgenciesCopsRelDiabetesNo"                 "urgenciesCopsRelDiabetesSi"                 "ingres_id"                                 
#[177] "urgencies_id"                               "consExterna_id"                             "consExternaCopsRelDiabetesNo"               "consExternaCopsRelDiabetesSi"              
#[181] "numTiresReact1Any"                          "costDerivacions"                            "costIncapacitatsTemp"                       "costLaboratori"                            
#[185] "costMedicacio"                              "costProfessionals"                          "costProvesCompl"                            "costTiresReactives"                        
#[189] "costVisites"                                "pacient_id"                                 "codiIdentificacioPacient"                   "codiPacient"                               
#[193] "estat"                                      "grupIntervencio"                            "usuari_id"                                  "centre_id"                                 
#[197] "codiUBA"                                    "abrevCentre"                                "codiCentre"                                 "nomCentre"                                 
#[201] "pacients"                                   "GR"                                         "dataCreacio"                                "dataConsentiment"                          
#[205] "motiuNoConsentiment"                        "inclusioConsentiment_id"                    "inclusioDxDM2_id"                           "inclusioEdat3080_id"                       
#[209] "inclusioHba1cGrau9minim_id"                 "inclusioSenseCanvisTt_id"                   "exclusioAltres_id"                          "exclusioDroguesAlcohol_id"                 
#[213] "exclusioEmabarasLactancia_id"               "exclusioFarmacsMetabHidrocarb_id"           "exclusioHemoglobinapatiesAnemia_id"         "exclusioIMCSuperior45_id"                  
#[217] "exclusioInsufCardiaca34NYHA_id"             "exclusioMalaltiaMentalDemencia_id"          "exclusioMalaltiaTerminal_id"                "exclusioParticipacioAssaigClinicFarmacs_id"
#[221] "exclusioTransplRenalDialisis_id"            "exclusioTtFarmacsAprimar_id"                "exclusioTtGlucocorticoides_id"              "exclusioTtImmunosupresors_id"              
#[225] "exclusioTtNeoplasiaMaligna_id"              "exclusioCanvisTt_id"                        "exclusioHba1cInferior9en3mesos_id"          "exclusioControlEndocrinoleg_id"            
#[229] "dataFiEstudi"                               "finalitzaEstudi_id"                         "motiuFinalEstudi_id"                        "totalBPAAT"                                
#[233] "activitatIntensa_id"                        "activitatModerada_id"                       "pregFrequenciaSucreAlt"                     "pregFrequenciaSucreBaix"                   
#[237] "pregRecomenacioTractament"                  "pregSatisfConeixMalaltia"                   "pregSatisfContTtActual"                     "pregSatisfaccioTtActual"                   
#[241] "pregTractamentFlexible"                     "pregTractamentPractic"                      "totalDTSQ"                                  "activitatPrincipalDescrip"                 
#[245] "codiPostal"                                 "escalaAVSalut"                              "treballSalutSocialDescrip"                  "activitatPrincipal_id"                     
#[249] "estudisRealitzats_id"                       "expMalGreuAltres_id"                        "expMalGreuFamiliar_id"                      "expMalGreuPersonal_id"                     
#[253] "pregAnsietat_id"                            "pregCuraPersonal_id"                        "pregDolor_id"                               "pregMovilitat_id"                          
#[257] "pregQuotidianes_id"                         "treballSalutSocial_id"                      "totalPAM"                                   "pregAutoMedicacio_id"                      
#[261] "pregConeixMedicaments_id"                   "pregConeixTtsDisponibles_id"                "pregEntenPSiCauses_id"                      "pregEstilVidaEstres_id"                    
#[265] "pregEvitarPS_id"                            "pregEvitarReduirPS_id"                      "pregHabitsSaludables_id"                    "pregInformarMetge_id"                      
#[269] "pregPaperActiu_id"                          "pregResponsable_id"                         "pregSeguiTtCasa_id"                         "pregSolucioNousPS_id"                      
#[273] "duracioDiabetesAnys2"                       "Macro"                                      "Micro" 
#
#
```


```{r recodes}
#conductor_variables<-"Integra_Conductor.xls"



#dades_BASAL_lab<-convertir_dates(d=dades_BASAL,taulavariables=conductor)
dades_BASAL<-etiquetar(d=dades_BASAL,taulavariables=conductor)
dades_BASAL<-etiquetar_valors(dt=dades_BASAL,variables_factors=conductor,fulla="etiquetes0",camp_etiqueta="etiqueta2")


# CAmbiar categoria de referencia
dades_BASAL<-dades_BASAL%>% refcat(conductor = conductor,ref = "refcat")

dades<-etiquetar(d=dades,taulavariables=conductor)
dades<-etiquetar_valors(dt=dades,variables_factors=conductor,fulla="etiquetes0",camp_etiqueta="etiqueta2")


# CAmbiar categoria de referencia
dades<-dades%>% refcat(conductor = conductor,ref = "refcat")

                          #####################################
                          #V  I S I T A       H I S T O R I C #------------------
                          #####################################

# 
# #conductor_variables<-"Integra_Conductor.xls"
# DT_VISITA_HISTORIC_lab<-convertir_dates(d=DT_VISITA_HISTORIC_FINAL,taulavariables=conductor)
# DT_VISITA_HISTORIC_lab<-etiquetar(d=DT_VISITA_HISTORIC_lab,taulavariables=conductor)
# DT_VISITA_HISTORIC_lab<-etiquetar_valors(dt=DT_VISITA_HISTORIC_lab,variables_factors=conductor,fulla="etiquetes0",camp_etiqueta="etiqueta1")


#repàs Altres!

table(dades$cardiopatiaIsquemica_id)
table(dades$CARDIOPATIAISQUEMICABASAL_id_ALTRES)




```

## 2. Descriptiva Basal

```{r Resultats0, include=T}

#i)


#formu_1<-formula_table1("taula",y="",taulavariables=conductor,dt=dades_basal)
formu_2<-formula_table1("taula_basal",y="grupIntervencio",taulavariables=conductor,dt=dades_BASAL)
formu_3<-formula_compare("taula_basal",y="grupIntervencio",taulavariables=conductor,dt=dades_BASAL)


#table1::table1(formu_2,
#               data = dades_BASAL,caption="TAULA 1.Descriptiva BASAL",
#               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
#               render.categorical="FREQ (PCTnoNA%)",
#               topclass="Rtable1-zebra")

table1::table1(formu_2,
               data = dades_BASAL,caption="TAULA 1.Descriptiva BASAL",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               topclass="Rtable1-zebra")


#descrTable(formu_3,
#           method =1,
#           data=dades_BASAL,
#           max.xlev = 200, 
#           max.ylev = 10,
#           show.p.overall=FALSE,
#           show.n = T,
#           show.all=T,
#          hide.no="No",simplify=F,digits=3)%>%export2md(header.background = "grey", header.color = "white", size=12,caption = "TAULA 1.Descriptiva BASAL")




```

```{r Resultats1, include=T}

#cluster:[]


#dades_BASAL_lab %>% select(centre_id)

table1::table1(~ centre_id  | grupIntervencio,
               data = dades_BASAL,caption="TAULA 1.Descriptiva BASAL:#cluster:[]",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")

```



## 3. Analisis de l'outcome (Change from baseline in HbA1c)

### 3.1 t-test Diferencia de mitjanes entre Basal i Final, dins de cada grup

```{r Resultats2, include=T, results='asis'}
#dades_BASAL_lab %>% select(hba1cNGSP)

#dades_final
#dades_MES03
#dades_MES06

dt_temp<-
  dades %>% 
  select(pacient_id,tipus,grupIntervencio,centre_id,hba1cNGSP) %>% 
  arrange(pacient_id) %>% 
  na.omit()


#dt_temp


## Reg logistica incondicional

dt_temp<-
  dades_BASAL %>% 
  left_join(
    
    dades %>% filter(tipus=="Mes12") %>% 
      select(pacient_id,hba1cNGSP_final=hba1cNGSP),
    by="pacient_id"
    
  )

dt_temp<-
  dt_temp %>% 
    mutate(hba1cNGSP_7=if_else(hba1cNGSP_final<7,1,0))

dt_temp<-
  dt_temp %>% 
    mutate(Dif=hba1cNGSP_final-hba1cNGSP)



dt_temp_s<-dt_temp%>%filter(grupIntervencio=="Sham")
dt_temp_i<-dt_temp%>%filter(grupIntervencio=="Intervention")

print("### t-test Diferencia de mitjanes entre Basal i Final,Grup Sham")

mean(dt_temp_s$Dif, na.rm=TRUE)
t.test(y = dt_temp_s$hba1cNGSP, x = dt_temp_s$hba1cNGSP_final, alternative = "two.sided", mu = 0, paired = TRUE, conf.level = 0.95)

print("### t-test Diferencia de mitjanes entre Basal i Final,Grup Intervention")


mean(dt_temp_i$Dif, na.rm=TRUE)
t.test(y = dt_temp_i$hba1cNGSP, x = dt_temp_i$hba1cNGSP_final, alternative = "two.sided", mu = 0, paired = TRUE, conf.level = 0.95)


#TAULA
```

### 3.2 Mitjanes (sd) hba1c (Basal ,Final) per cada Grup [Grup Intervenció i Grup Sham] 
```{r Resultats3, include=T}
table1::table1(~ hba1cNGSP,
               data = dt_temp_i,caption="Grup Intervenció.Interval Confiança Mitjanes Glicada Basal",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")

table1::table1(~ hba1cNGSP_final,
               data = dt_temp_i,caption="Grup Intervenció.Interval Confiança Mitjanes  Glicada Final",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")

table1::table1(~ hba1cNGSP,
               data = dt_temp_s,caption="Grup Sham.Interval Confiança Mitjanes Glicada Basal",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")

table1::table1(~ hba1cNGSP_final,
               data = dt_temp_s,caption="Grup Sham.Interval Confiança Mitjanes  Glicada Final",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")
```

### 3.3 Regressio Lineal Mitjanes de Diferència hba1c

```{r Resultats4, include=T}
#-------------------------------------------------------------------------------------#
print("Regressio Lineal Mitjanes de Diferència hba1c")

#devtools::install_github("strengejacke/sjPlot")

glm(Dif~hba1cNGSP        ,family = "gaussian",data = dt_temp)%>%parameters::parameters(exp=F)

kk<-glm(Dif~hba1cNGSP        ,family = "gaussian",data = dt_temp)
plot_model(kk)

```

### 3.4 Regressio Lineal Mitjanes de Diferència hba1c amb Cluster.

```{r Resultats5, include=T}
print("Regressio Lineal Mitjanes de Diferència hba1c amb CLUSTER (Id_Centre")
#
mod_lineal_cluster<-miceadds::glm.cluster(data=dt_temp, formula=Dif~hba1cNGSP , cluster="centre_id", family="gaussian")
summary(mod_lineal_cluster)

```


### 3.5 Regressio Logística Incondicional hba1c<7%

```{r Resultats6, include=T}
#falta TOTAL,HDLC,LDLC [[BOGDAN]]???

print("Regressio Logística Incondicional hba1c<7%")


glm(hba1cNGSP_7~grupIntervencio+edat+sexe_id + duracioDiabetesAnys+hta_id+dislipemia_id +imc+Micro+Macro ,family = "binomial",data = dt_temp) %>% 
  parameters::parameters(exp=T)



ramo<-glm(hba1cNGSP_7~grupIntervencio+edat+sexe_id + duracioDiabetesAnys+hta_id+dislipemia_id +imc+Micro+Macro ,family = "binomial",data = dt_temp) 
#print(forest_model(ramo,factor_separate_line = TRUE))
plot_model(ramo)
```

### 3.6 Regressio Logística Condicional hba1c<7%

```{r Resultats7, include=T}

print("Regressio Logística Condicional hba1c<7%")


mod_cluster<-miceadds::glm.cluster(data=dt_temp, formula=hba1cNGSP_7~grupIntervencio+edat+sexe_id + duracioDiabetesAnys+hta_id+dislipemia_id +imc+Micro+Macro, cluster="centre_id", family="binomial")

summary(mod_cluster)



### Taula de coeficients

coef<-exp(confint(mod_cluster)) %>% row.names()

taula_coef=exp(confint(mod_cluster)) %>% as_tibble()

taula_coef %>% bind_cols(coef) %>% 
  bind_cols(exp(coef(mod_cluster))) %>% 
  select(var="...3",OR="...4",IC95_linf="2.5 %",IC95_lsup="97.5 %") %>%
  filter(var!="(Intercept)") %>% 
  kable(caption="Reg logistica Condicional",digits = 2) %>% 
  kableExtra::kable_classic_2()



#a <- mod_cluster$glm_res[1]
#b <- mod_cluster$estimate[2]


```
## 4. Salvar taula plana
```{r salvar}
#saveRDS(dades, file=here::here(params$dir_dades_desti,"dt_plana_exc.rds"))

```
&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>



