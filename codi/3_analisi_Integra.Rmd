---
title: "Estudi INTEGRA: estratègia d'INTervenció intEgral en pacients amb mal control Glucèmic de la diabetis mellitus tipus 2 a l'Àmbit d'Atenció PRimariA"
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"

output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades_desti: "dades"
---
&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****

## 0. Estat:

**agregacions i part global descriptiva**


&check; xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <br/>


Desembre / 2021

&check; xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx <br/>



 
**Pendents**

&check; Revisio i depuracio errors.   <br/>

# Fase de validacio de base

## Fase Preparacio


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

gc()

library("plyr")
library("dplyr")
library("purrr")
library("stringr")
library("tidyr")
library("compareGroups")
library("rmarkdown")
library("RODBC")
library("devtools")
library("pander")
library("hablar")
library("miceadds")
library("ggplot2")
library("survminer")
library("survival")
library("forestmodel")
library("sjmisc")
library(devtools)

# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

directori_dades<-params$dir_dades_origen

conductor<-here::here("Integra_Conductor.xls")


```

```{r llegir, include = FALSE}


#######################################################
# Llegir plana
#dades_basal<-readRDS(here::here(params$dir_dades_desti,"TAULA_PLANA_BASAL_LAB.rds")) %>% as_tibble()
#dades<-readRDS(here::here(params$dir_dades_desti,"TAULA_PLANA_HISTORIC_LAB.rds")) %>% as_tibble()



dades<-readRDS(here::here(params$dir_dades_desti,"TAULA_PLANA.rds")) %>% as_tibble()

dades_BASAL<-dades%>%filter(tipus=="Mes00")
dades_MES03<-dades%>%filter(tipus=="Mes03")
dades_MES06<-dades%>%filter(tipus=="Mes06")
dades_FINAL<-dades%>%filter(tipus=="Mes12")



```
## 1. Flow chart 
```{r Flow chart, include=T}



dades_BASAL<-dades_BASAL%>%mutate(exclusio1=ifelse(duracioDiabetesMesos2<12,1,0))
#dades<-dades%>%mutate(exclusio1=ifelse(duracioDiabetesMesos2<12,1,0))



#flow_chart1<-criteris_exclusio_diagrama(dt=dades_BASAL,
#                                        taulavariables=conductor,
#                                        criteris = "exc_pre",
#                                        ordre="exc_ordre",
#                                        grups=NA,
#                                        etiquetes="descripcio",
#                                        sequencial = T,
#                                        pob_lab=c("Estudio INTEGRA  ","Estudio INTEGRA sin exclusiones"),
#                                        colors=c("white","grey"),
#                                        forma=c("ellipse","box"))

#flow_chart1




#DT_VISITA_HISTORIC<-DT_VISITA_HISTORIC%>%filter(pacient_id%in%DT_PACIENT_SELECT$pacient_id)
#mydata %>% filter(! is.na(important_a) | ! is.na(important_b))

dades_BASAL<-dades_BASAL%>%filter(exclusio1==0 &  !is.na(hba1cNGSP))



#filtrem les altres base de dades!


dades_BASAL_SELECT<-dades_BASAL%>%dplyr::select(pacient_id)


dades_MES03<-dades_MES03%>%filter(pacient_id%in%dades_BASAL_SELECT$pacient_id)
dades_MES06<-dades_MES06%>%filter(pacient_id%in%dades_BASAL_SELECT$pacient_id)
dades_FINAL<-dades_FINAL%>%filter(pacient_id%in%dades_BASAL_SELECT$pacient_id)
dades<-dades%>%filter(pacient_id%in%dades_BASAL_SELECT$pacient_id)





```


```{r recodes}
#conductor_variables<-"Integra_Conductor.xls"



#dades_BASAL_lab<-convertir_dates(d=dades_BASAL,taulavariables=conductor)
dades_BASAL<-etiquetar(d=dades_BASAL,taulavariables=conductor)
dades_BASAL<-etiquetar_valors(dt=dades_BASAL,variables_factors=conductor,fulla="etiquetes0",camp_etiqueta="etiqueta2")


# CAmbiar categoria de referencia
dades_BASAL<-dades_BASAL%>% refcat(conductor = conductor,ref = "refcat")

dades<-etiquetar(d=dades,taulavariables=conductor)
dades<-etiquetar_valors(dt=dades,variables_factors=conductor,fulla="etiquetes0",camp_etiqueta="etiqueta2")


# CAmbiar categoria de referencia
dades<-dades%>% refcat(conductor = conductor,ref = "refcat")

                          #####################################
                          #V  I S I T A       H I S T O R I C #------------------
                          #####################################

# 
# #conductor_variables<-"Integra_Conductor.xls"
# DT_VISITA_HISTORIC_lab<-convertir_dates(d=DT_VISITA_HISTORIC_FINAL,taulavariables=conductor)
# DT_VISITA_HISTORIC_lab<-etiquetar(d=DT_VISITA_HISTORIC_lab,taulavariables=conductor)
# DT_VISITA_HISTORIC_lab<-etiquetar_valors(dt=DT_VISITA_HISTORIC_lab,variables_factors=conductor,fulla="etiquetes0",camp_etiqueta="etiqueta1")


```

## 2. Descriptiva Basal

```{r Resultats0, include=T}

#i)


#formu_1<-formula_table1("taula",y="",taulavariables=conductor,dt=dades_basal)
formu_2<-formula_table1("taula_basal",y="grupIntervencio",taulavariables=conductor,dt=dades_BASAL)
formu_3<-formula_compare("taula_basal",y="grupIntervencio",taulavariables=conductor,dt=dades_BASAL)


table1::table1(formu_2,
               data = dades_BASAL,caption="TAULA 1.Descriptiva BASAL",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")


#descrTable(formu_3,
#           method =1,
#           data=dades_BASAL,
#           max.xlev = 200, 
#           max.ylev = 10,
#           show.p.overall=FALSE,
#           show.n = T,
#           show.all=T,
#          hide.no="No",simplify=F,digits=3)%>%export2md(header.background = "grey", header.color = "white", size=12,caption = "TAULA 1.Descriptiva BASAL")




```

```{r Resultats1, include=T}

#cluster:[]


#dades_BASAL_lab %>% select(centre_id)

table1::table1(~ centre_id  | grupIntervencio,
               data = dades_BASAL,caption="TAULA 1.Descriptiva BASAL:#cluster:[]",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")

```



## 3. Analisis de l'outcome (Change from baseline in HbA1c)

```{r Resultats2, include=T}


#dades_BASAL_lab %>% select(hba1cNGSP)

#dades_final
#dades_MES03
#dades_MES06

dt_temp<-
  dades %>% 
  select(pacient_id,tipus,grupIntervencio,centre_id,hba1cNGSP) %>% 
  arrange(pacient_id) %>% 
  na.omit()


#dt_temp


## Reg logistica incondicional

dt_temp<-
  dades_BASAL %>% 
  left_join(
    
    dades %>% filter(tipus=="Mes12") %>% 
      select(pacient_id,hba1cNGSP_final=hba1cNGSP),
    by="pacient_id"
    
  )

dt_temp<-
  dt_temp %>% 
    mutate(hba1cNGSP_7=if_else(hba1cNGSP_final<7,1,0))

dt_temp<-
  dt_temp %>% 
    mutate(Dif=hba1cNGSP_final-hba1cNGSP)

dt_temp_s<-dt_temp%>%filter(grupIntervencio=="Sham")
dt_temp_i<-dt_temp%>%filter(grupIntervencio=="Intervention")

print("t-test Diferencia de mitjanes entre Basal i Final,Grup Sham")

mean(dt_temp_s$Dif, na.rm=TRUE)
t.test(y = dt_temp_s$hba1cNGSP, x = dt_temp_s$hba1cNGSP_final, alternative = "two.sided", mu = 0, paired = TRUE, conf.level = 0.95)

print("t-test Diferencia de mitjanes entre Basal i Final,Grup Intervention")


mean(dt_temp_i$Dif, na.rm=TRUE)
t.test(y = dt_temp_i$hba1cNGSP, x = dt_temp_i$hba1cNGSP_final, alternative = "two.sided", mu = 0, paired = TRUE, conf.level = 0.95)

#TAULA 



table1::table1(~ hba1cNGSP,
               data = dt_temp_i,caption="Grup Intervenció.Interval Confiança Mitjanes Glicada Basal",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")

table1::table1(~ hba1cNGSP_final,
               data = dt_temp_i,caption="Grup Intervenció.Interval Confiança Mitjanes  Glicada Final",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")

table1::table1(~ hba1cNGSP,
               data = dt_temp_s,caption="Grup Sham.Interval Confiança Mitjanes Glicada Basal",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")

table1::table1(~ hba1cNGSP_final,
               data = dt_temp_s,caption="Grup Sham.Interval Confiança Mitjanes  Glicada Final",
               render.continuous=c(.="N",.="Mean (SD)", .="Median [Min, Max]"),
               render.categorical="FREQ (PCTnoNA%)",
               topclass="Rtable1-zebra")



#-------------------------------------------------------------------------------------#


print("Regressio Lineal Mitjanes de Diferència hba1c")

#devtools::install_github("strengejacke/sjPlot")

#summary(glm(Dif~hba1cNGSP     ,family = "gaussian",data = dt_temp) )
  
glm(Dif~hba1cNGSP        ,family = "gaussian",data = dt_temp)%>% 
  parameters::parameters(exp=F)

kk<-glm(Dif~hba1cNGSP        ,family = "gaussian",data = dt_temp)
plot_model(kk)

print("Regressio Lineal Mitjanes de Diferència hba1c amb CLUSTER (Id_Centre")

mod_lineal_cluster<-miceadds::glm.cluster(data=dt_temp, formula=Dif~hba1cNGSP , cluster="centre_id", family="gaussian")
summary(mod_lineal_cluster)



#library(sjmisc)
#data(efc)
#efc <- to_factor(efc, c161sex, e42dep, c172code)
#m <- lm(neg_c_7 ~ pos_v_4 + c12hour + e42dep + c172code, data = efc)
#m
# simple forest plot
#plot_model(m)


#falta TOTAL,HDLC,LDLC [[BOGDAN]]

print("Regressio Logística Incondicional hba1c<7%")


glm(hba1cNGSP_7~grupIntervencio+edat+sexe_id + duracioDiabetesAnys2+hta_id+dislipemia_id +imc+Micro+Macro ,family = "binomial",data = dt_temp) %>% 
  parameters::parameters(exp=T)



ramo<-glm(hba1cNGSP_7~grupIntervencio+edat+sexe_id + duracioDiabetesAnys2+hta_id+dislipemia_id +imc+Micro+Macro ,family = "binomial",data = dt_temp) 
#print(forest_model(ramo,factor_separate_line = TRUE))
plot_model(ramo)




## Reg logistica condicional
#
#
#
#dt_temp<-
#  dades_BASAL %>% 
#  left_join(
#    
#    dades %>% filter(tipus=="Mes12") %>% 
#      select(pacient_id,hba1cNGSP_final=hba1cNGSP),
#    by="pacient_id"
#    
#  )
#
#dt_temp<-
#  dt_temp %>% 
#    mutate(hba1cNGSP_7=if_else(hba1cNGSP_final<7,1,0))
#
#
#dt_temp<-dt_temp%>%select(pacient_id,hba1cNGSP_7)
#
#dt_temp2<-dades%>%filter(tipus=="Mes00" | tipus=="Mes12")%>%left_join(dt_temp , "pacient_id")
#  
#mod2<-miceadds::glm.cluster(data=dt_temp2, formula=hba1cNGSP_7~grupIntervencio+edat+sexe_id + duracioDiabetesAnys2+hta_id+dislipemia_id +imc,
#                            cluster="pacient_id", family="binomial")
#exp(summary(mod2))
#
##

print("Regressio Logística Condicional hba1c<7%")


mod_cluster<-miceadds::glm.cluster(data=dt_temp, formula=hba1cNGSP_7~grupIntervencio+edat+sexe_id + duracioDiabetesAnys2+hta_id+dislipemia_id +imc+Micro+Macro, cluster="centre_id", family="binomial")
exp(summary(mod_cluster))





```
## 4. Salvar taula plana
```{r salvar}
#saveRDS(dades, file=here::here(params$dir_dades_desti,"dt_plana_exc.rds"))

```
&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>



